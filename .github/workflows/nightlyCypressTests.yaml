name: Nightly Cypress Tests

on:
  schedule:
    # Runs at 1 AM UTC every weekday (Monday to Friday)
    - cron: "0 1 * * 1-5"
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment to test"
        required: true
        default: "all"
        type: choice
        options: [all, qat, dev, preprod]
      branch:
        description: "Branch to run tests against"
        required: false
        default: "develop"
        type: string
      browsers:
        description: "Select browsers to test"
        required: true
        default: "all"
        type: choice
        options: [all, chrome, firefox, edge]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  setup-matrix:
    name: Setup Test Matrix
    runs-on: ubuntu-latest
    outputs:
      browsers: ${{ steps.matrix.outputs.browsers }}
      environments: ${{ steps.matrix.outputs.environments }}
    steps:
      - name: Setup test matrix
        id: matrix
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BROWSER_SELECTION="${{ github.event.inputs.browsers }}"
            ENV_SELECTION="${{ github.event.inputs.environment }}"
          else
            BROWSER_SELECTION="all"
            ENV_SELECTION="all"
          fi

          if [[ "$BROWSER_SELECTION" == "all" ]]; then
            BROWSER_ARRAY='["chrome", "firefox", "edge"]'
          else
            BROWSER_ARRAY='["'$BROWSER_SELECTION'"]'
          fi
          echo "browsers=$BROWSER_ARRAY" >> $GITHUB_OUTPUT

          if [[ "$ENV_SELECTION" == "all" ]]; then
            ENV_ARRAY='["qat", "dev", "preprod"]'
          else
            ENV_ARRAY='["'$ENV_SELECTION'"]'
          fi
          echo "environments=$ENV_ARRAY" >> $GITHUB_OUTPUT

          echo "Selected browsers: $BROWSER_ARRAY"
          echo "Selected environments: $ENV_ARRAY"

  cypress-nightly:
    name: Run Cypress Tests - ${{ matrix.environment }} - ${{ matrix.browser }}
    runs-on: ubuntu-latest
    needs: setup-matrix
    strategy:
      fail-fast: false
      matrix:
        browser: ${{ fromJson(needs.setup-matrix.outputs.browsers) }}
        environment: ${{ fromJson(needs.setup-matrix.outputs.environments) }}

    env:
      USER_1_EMAIL: ${{ secrets.USER_1_EMAIL }}
      USER_1_PASSWORD: ${{ secrets.USER_1_PASSWORD }}
      USER_2_EMAIL: ${{ secrets.USER_2_EMAIL }}
      USER_2_PASSWORD: ${{ secrets.USER_2_PASSWORD }}
      USER_3_EMAIL: ${{ secrets.USER_3_EMAIL }}
      USER_3_PASSWORD: ${{ secrets.USER_3_PASSWORD }}
      USER_4_EMAIL: ${{ secrets.USER_4_EMAIL }}
      USER_4_PASSWORD: ${{ secrets.USER_4_PASSWORD }}
      USER_5_EMAIL: ${{ secrets.USER_5_EMAIL }}
      USER_5_PASSWORD: ${{ secrets.USER_5_PASSWORD }}
      USER_6_EMAIL: ${{ secrets.USER_6_EMAIL }}
      USER_6_PASSWORD: ${{ secrets.USER_6_PASSWORD }}
      TEST_ENVIRONMENT: ${{ matrix.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: pets-ui/package-lock.json

      - name: Cache Cypress binary
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: cypress-binary-${{ runner.os }}-${{ hashFiles('pets-ui/package-lock.json') }}
          restore-keys: |
            cypress-binary-${{ runner.os }}-

      - name: Install dependencies
        working-directory: pets-ui
        run: npm ci

      - name: Verify Cypress installation
        working-directory: pets-ui
        run: npx cypress verify

      - name: Cypress run tests (Initial attempt)
        uses: cypress-io/github-action@v6
        continue-on-error: true
        id: initial_attempt
        with:
          install: false
          working-directory: pets-ui
          browser: ${{ matrix.browser }}
          config-file: cypress.config.mjs
        env:
          ENVIRONMENT: ${{ matrix.environment }}
          CYPRESS_TEST_ENVIRONMENT: ${{ matrix.environment }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Retry failed tests
        if: steps.initial_attempt.outcome != 'success'
        uses: cypress-io/github-action@v6
        continue-on-error: true
        id: retry_attempt
        with:
          install: false
          working-directory: pets-ui
          browser: ${{ matrix.browser }}
          config-file: cypress.config.mjs
        env:
          ENVIRONMENT: ${{ matrix.environment }}
          CYPRESS_TEST_ENVIRONMENT: ${{ matrix.environment }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.environment }}-${{ matrix.browser }}
          path: pets-ui/cypress/screenshots
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: videos-${{ matrix.environment }}-${{ matrix.browser }}
          path: pets-ui/cypress/videos
          if-no-files-found: ignore
          retention-days: 7

      - name: Install jq for JSON processing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Merge Mochawesome reports
        if: always()
        working-directory: pets-ui
        run: |
          # Install mochawesome-merge if not already installed
          npm list mochawesome-merge || npm install --save-dev mochawesome-merge

          REPORT_DIR="cypress/reports/mochawesome"
          MERGED_FILE="$REPORT_DIR/mochawesome.json"

          echo "=== Searching for Mochawesome reports ==="
          mkdir -p "$REPORT_DIR"

          # Find all JSON report files
          JSON_FILES=($(find "$REPORT_DIR" -name "*.json" -not -name "mochawesome.json" 2>/dev/null || true))

          if [ ${#JSON_FILES[@]} -gt 0 ]; then
            echo "Found ${#JSON_FILES[@]} report files to merge"
            npx mochawesome-merge "${JSON_FILES[@]}" > "$MERGED_FILE"
            echo "‚úÖ Reports merged successfully"
            
            # Show merged stats
            if [ -f "$MERGED_FILE" ]; then
              echo "=== Merged Test Statistics ==="
              jq '.stats' "$MERGED_FILE" || echo "Could not parse stats"
            fi
          else
            echo "‚ö†Ô∏è No mochawesome reports found - creating minimal report"
            echo '{"stats":{"suites":0,"tests":0,"passes":0,"pending":0,"failures":0},"results":[]}' > "$MERGED_FILE"
          fi

      - name: Extract test counts
        if: always()
        id: extract_counts
        working-directory: pets-ui
        run: |
          JSON_FILE="cypress/reports/mochawesome/mochawesome.json"

          if [ -f "$JSON_FILE" ]; then
            TOTAL=$(jq -r '.stats.tests // 0' "$JSON_FILE")
            PASSED=$(jq -r '.stats.passes // 0' "$JSON_FILE")
            FAILED=$(jq -r '.stats.failures // 0' "$JSON_FILE")
            PENDING=$(jq -r '.stats.pending // 0' "$JSON_FILE")
            
            echo "total_count=$TOTAL" >> $GITHUB_OUTPUT
            echo "passed_count=$PASSED" >> $GITHUB_OUTPUT
            echo "failed_count=$FAILED" >> $GITHUB_OUTPUT
            echo "pending_count=$PENDING" >> $GITHUB_OUTPUT
            
            echo "‚úÖ Test counts: Total=$TOTAL, Passed=$PASSED, Failed=$FAILED, Pending=$PENDING"
          else
            echo "‚ö†Ô∏è No merged report found - using default values"
            echo "total_count=0" >> $GITHUB_OUTPUT
            echo "passed_count=0" >> $GITHUB_OUTPUT
            echo "failed_count=0" >> $GITHUB_OUTPUT
            echo "pending_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload mochawesome report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mochawesome-report-${{ matrix.environment }}-${{ matrix.browser }}
          path: pets-ui/cypress/reports/mochawesome/mochawesome.json
          if-no-files-found: warn
          retention-days: 7

      - name: Store test result
        if: always()
        run: |
          # Determine overall status
          if [[ "${{ steps.initial_attempt.outcome }}" == "success" ]] || [[ "${{ steps.retry_attempt.outcome }}" == "success" ]]; then
            STATUS="PASS"
          else
            STATUS="FAIL"
          fi

          # Create result files
          echo "$STATUS" > result.txt

          cat > result.json << EOF
          {
            "status": "$STATUS",
            "environment": "${{ matrix.environment }}",
            "browser": "${{ matrix.browser }}",
            "testCounts": {
              "total": ${{ steps.extract_counts.outputs.total_count }},
              "passed": ${{ steps.extract_counts.outputs.passed_count }},
              "failed": ${{ steps.extract_counts.outputs.failed_count }},
              "pending": ${{ steps.extract_counts.outputs.pending_count }}
            },
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "runId": "${{ github.run_id }}",
            "attempt": {
              "initial": "${{ steps.initial_attempt.outcome }}",
              "retry": "${{ steps.retry_attempt.outcome }}"
            }
          }
          EOF

          echo "Created result files with status: $STATUS"

      - name: Upload test result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: result-${{ matrix.environment }}-${{ matrix.browser }}
          path: |
            result.txt
            result.json
          retention-days: 7

  generate-summary-and-deploy:
    name: Generate Summary and Deploy Dashboard
    needs: [setup-matrix, cypress-nightly]
    if: always()
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install required tools
        run: sudo apt-get update && sudo apt-get install -y jq bc

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: List downloaded artifacts
        run: |
          echo "=== Downloaded Artifacts ==="
          find all-artifacts -type f | sort

      - name: Create dashboard directory
        run: mkdir -p dashboard

      - name: Generate test summary report
        id: summary
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
          NEEDS_MATRIX: ${{ toJson(needs.setup-matrix.outputs) }}
        run: |
          #!/bin/bash
          set -e

          echo "# üåô Nightly Cypress Test Results" > nightly-summary.md
          echo "" >> nightly-summary.md
          echo "**Run Date**: $(date -u)" >> nightly-summary.md
          echo "**Run ID**: ${{ github.run_id }}" >> nightly-summary.md
          echo "**Branch**: ${{ github.event.inputs.branch || github.ref_name }}" >> nightly-summary.md
          echo "" >> nightly-summary.md

          ENV_MATRIX='${{ needs.setup-matrix.outputs.environments }}'
          BROWSER_MATRIX='${{ needs.setup-matrix.outputs.browsers }}'
          ENV_LIST=($(echo $ENV_MATRIX | jq -r '.[]'))
          BROWSER_LIST=($(echo $BROWSER_MATRIX | jq -r '.[]'))

          TOTAL=0
          FAILS=0
          TOTAL_TESTS=0
          TOTAL_PASSED=0
          TOTAL_FAILED=0
          TOTAL_PENDING=0

          # Start JSON file
          echo "{" > dashboard/test-results.json
          echo '  "results": {' >> dashboard/test-results.json

          FIRST_ENV=true
          for env in "${ENV_LIST[@]}"; do
            echo "## Environment: ${env^^}" >> nightly-summary.md
            echo "" >> nightly-summary.md
            echo "| Browser | Status | Total | Passed | Failed | Pending |" >> nightly-summary.md
            echo "|---------|--------|-------|--------|--------|---------|" >> nightly-summary.md
            
            if [ "$FIRST_ENV" = false ]; then
              echo "," >> dashboard/test-results.json
            fi
            echo "    \"$env\": {" >> dashboard/test-results.json
            FIRST_ENV=false
            
            FIRST_BROWSER=true
            for browser in "${BROWSER_LIST[@]}"; do
              RESULT_DIR="all-artifacts/result-${env}-${browser}"
              STATUS="UNKNOWN"
              TEST_COUNT=0
              PASSED_COUNT=0
              FAILED_COUNT=0
              PENDING_COUNT=0
              
              if [ -f "$RESULT_DIR/result.txt" ]; then
                STATUS=$(cat "$RESULT_DIR/result.txt")
              fi
              
              if [ -f "$RESULT_DIR/result.json" ]; then
                TEST_COUNT=$(jq -r '.testCounts.total // 0' "$RESULT_DIR/result.json")
                PASSED_COUNT=$(jq -r '.testCounts.passed // 0' "$RESULT_DIR/result.json")
                FAILED_COUNT=$(jq -r '.testCounts.failed // 0' "$RESULT_DIR/result.json")
                PENDING_COUNT=$(jq -r '.testCounts.pending // 0' "$RESULT_DIR/result.json")
              fi
              
              STATUS_ICON=$([ "$STATUS" = "PASS" ] && echo "‚úÖ" || echo "‚ùå")
              echo "| $browser | $STATUS_ICON $STATUS | $TEST_COUNT | $PASSED_COUNT | $FAILED_COUNT | $PENDING_COUNT |" >> nightly-summary.md
              
              if [ "$FIRST_BROWSER" = false ]; then
                echo "," >> dashboard/test-results.json
              fi
              
              echo "      \"$browser\": {" >> dashboard/test-results.json
              echo "        \"status\": \"$STATUS\"," >> dashboard/test-results.json
              echo "        \"testCounts\": {" >> dashboard/test-results.json
              echo "          \"total\": $TEST_COUNT," >> dashboard/test-results.json
              echo "          \"passed\": $PASSED_COUNT," >> dashboard/test-results.json
              echo "          \"failed\": $FAILED_COUNT," >> dashboard/test-results.json
              echo "          \"pending\": $PENDING_COUNT" >> dashboard/test-results.json
              echo "        }" >> dashboard/test-results.json
              echo "      }" >> dashboard/test-results.json
              
              FIRST_BROWSER=false
              
              TOTAL=$((TOTAL + 1))
              [ "$STATUS" != "PASS" ] && FAILS=$((FAILS + 1))
              TOTAL_TESTS=$((TOTAL_TESTS + TEST_COUNT))
              TOTAL_PASSED=$((TOTAL_PASSED + PASSED_COUNT))
              TOTAL_FAILED=$((TOTAL_FAILED + FAILED_COUNT))
              TOTAL_PENDING=$((TOTAL_PENDING + PENDING_COUNT))
            done
            
            echo "    }" >> dashboard/test-results.json
            echo "" >> nightly-summary.md
          done

          echo "  }," >> dashboard/test-results.json

          if [ $TOTAL -gt 0 ]; then
            SUCCESS_RATE=$(echo "scale=1; ($TOTAL - $FAILS) * 100 / $TOTAL" | bc)
          else
            SUCCESS_RATE=0
          fi

          echo "## üìä Overall Summary" >> nightly-summary.md
          echo "" >> nightly-summary.md
          echo "- **Test Combinations**: $TOTAL" >> nightly-summary.md
          echo "- **Failed Combinations**: $FAILS" >> nightly-summary.md
          echo "- **Success Rate**: ${SUCCESS_RATE}%" >> nightly-summary.md
          echo "- **Total Tests Run**: $TOTAL_TESTS" >> nightly-summary.md
          echo "- **Tests Passed**: $TOTAL_PASSED" >> nightly-summary.md
          echo "- **Tests Failed**: $TOTAL_FAILED" >> nightly-summary.md
          echo "- **Tests Pending**: $TOTAL_PENDING" >> nightly-summary.md
          echo "" >> nightly-summary.md

          if [ $FAILS -eq 0 ]; then
            OVERALL_STATUS="PASS"
            echo "## ‚úÖ Status: ALL TESTS PASSED" >> nightly-summary.md
          else
            OVERALL_STATUS="FAIL"
            echo "## ‚ùå Status: SOME TESTS FAILED" >> nightly-summary.md
          fi

          echo "  \"overallStatus\": \"$OVERALL_STATUS\"," >> dashboard/test-results.json
          echo "  \"totalCombinations\": $TOTAL," >> dashboard/test-results.json
          echo "  \"failedCombinations\": $FAILS," >> dashboard/test-results.json
          echo "  \"totalTests\": $TOTAL_TESTS," >> dashboard/test-results.json
          echo "  \"totalPassed\": $TOTAL_PASSED," >> dashboard/test-results.json
          echo "  \"totalFailed\": $TOTAL_FAILED," >> dashboard/test-results.json
          echo "  \"totalPending\": $TOTAL_PENDING," >> dashboard/test-results.json
          echo "  \"successRate\": $SUCCESS_RATE," >> dashboard/test-results.json
          echo "  \"runUrl\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"," >> dashboard/test-results.json
          echo "  \"branch\": \"${{ github.event.inputs.branch || github.ref_name }}\"," >> dashboard/test-results.json
          echo "  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"" >> dashboard/test-results.json
          echo "}" >> dashboard/test-results.json

          echo "overall_status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT

      - name: Create dashboard HTML
        run: cp .github/workflows/dashboard-template.html dashboard/index.html

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./dashboard"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Upload summary report
        uses: actions/upload-artifact@v4
        with:
          name: nightly-summary-report
          path: nightly-summary.md
          retention-days: 30

      - name: Create GitHub Step Summary
        if: always()
        run: |
          cat nightly-summary.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "üìä **[View Live Dashboard](${{ steps.deployment.outputs.page_url }})**" >> $GITHUB_STEP_SUMMARY

      - name: Set final status
        if: always()
        run: |
          if [[ "${{ steps.summary.outputs.overall_status }}" == "PASS" ]]; then
            echo "::notice::‚úÖ All tests passed! Dashboard: ${{ steps.deployment.outputs.page_url }}"
            exit 0
          else
            echo "::warning::‚ö†Ô∏è Some tests failed. Dashboard: ${{ steps.deployment.outputs.page_url }}"
            exit 1
          fi
