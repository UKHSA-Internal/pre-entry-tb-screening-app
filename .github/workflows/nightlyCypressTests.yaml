name: Nightly Cypress Tests

on:
  schedule:
    # Runs at 1 AM UTC every weekday (Monday to Friday)
    - cron: "0 1 * * 1-5"
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select environment to test'
        required: true
        default: "all"
        type: choice
        options: [all, qat, dev, preprod]
      browsers:
        description: 'Select browsers to test'
        required: true
        default: "all"
        type: choice
        options: [all, chrome, firefox, edge]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  setup-matrix:
    name: Setup Test Matrix
    runs-on: ubuntu-latest
    outputs:
      browsers: ${{ steps.matrix.outputs.browsers }}
      environments: ${{ steps.matrix.outputs.environments }}
    steps:
      - name: Setup test matrix
        id: matrix
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BROWSER_SELECTION="${{ github.event.inputs.browsers }}"
            ENV_SELECTION="${{ github.event.inputs.environment }}"
          else
            BROWSER_SELECTION="all"
            ENV_SELECTION="all"
          fi

          if [[ "$BROWSER_SELECTION" == "all" ]]; then
            BROWSER_ARRAY='["chrome", "firefox", "edge"]'
          else
            BROWSER_ARRAY='["'$BROWSER_SELECTION'"]'
          fi
          echo "browsers=$BROWSER_ARRAY" >> $GITHUB_OUTPUT

          if [[ "$ENV_SELECTION" == "all" ]]; then
            ENV_ARRAY='["qat", "dev", "preprod"]'
          else
            ENV_ARRAY='["'$ENV_SELECTION'"]'
          fi
          echo "environments=$ENV_ARRAY" >> $GITHUB_OUTPUT

          echo "Selected browsers: $BROWSER_ARRAY"
          echo "Selected environments: $ENV_ARRAY"

  cypress-nightly:
    name: Run Cypress Tests - ${{ matrix.environment }} - ${{ matrix.browser }}
    runs-on: ubuntu-latest
    needs: setup-matrix
    strategy:
      fail-fast: false
      matrix:
        browser: ${{ fromJson(needs.setup-matrix.outputs.browsers) }}
        environment: ${{ fromJson(needs.setup-matrix.outputs.environments) }}

    env:
      USER_1_EMAIL: ${{ secrets.USER_1_EMAIL }}
      USER_1_PASSWORD: ${{ secrets.USER_1_PASSWORD }}
      USER_2_EMAIL: ${{ secrets.USER_2_EMAIL }}
      USER_2_PASSWORD: ${{ secrets.USER_2_PASSWORD }}
      USER_3_EMAIL: ${{ secrets.USER_3_EMAIL }}
      USER_3_PASSWORD: ${{ secrets.USER_3_PASSWORD }}
      USER_4_EMAIL: ${{ secrets.USER_4_EMAIL }}
      USER_4_PASSWORD: ${{ secrets.USER_4_PASSWORD }}
      USER_5_EMAIL: ${{ secrets.USER_5_EMAIL }}
      USER_5_PASSWORD: ${{ secrets.USER_5_PASSWORD }}
      USER_6_EMAIL: ${{ secrets.USER_6_EMAIL }}
      USER_6_PASSWORD: ${{ secrets.USER_6_PASSWORD }}
      TEST_ENVIRONMENT: ${{ matrix.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm i

      - name: Debug available Cypress specs
        run: ls -R pets-ui/cypress/e2e

      - name: Cache Cypress binary
        id: cache-cypress-binary
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: cypress-binary-nightly-${{ runner.os }}-${{ hashFiles('pets-ui/package.json') }}

      - name: Install Cypress Binary
        if: steps.cache-cypress-binary.outputs.cache-hit != 'true'
        run: |
          pnpm exec cypress install --force
          pnpm exec cypress verify
        working-directory: pets-ui

      - name: Start Local Environment
        run: |
          pnpm start & sleep 120

      - name: Cypress run tests
        uses: cypress-io/github-action@v6
        continue-on-error: true
        id: initial_attempt
        with:
          install: false
          working-directory: pets-ui
          browser: ${{ matrix.browser }}
          config-file: cypress/cypress.config.mjs
        env:
          CYPRESS_TEST_ENVIRONMENT: ${{ matrix.environment }}

      - name: Retry if failed
        if: steps.initial_attempt.outcome != 'success'
        uses: cypress-io/github-action@v6
        id: retry_attempt
        with:
          install: false
          working-directory: pets-ui
          browser: ${{ matrix.browser }}
          config-file: cypress/cypress.config.mjs
        env:
          CYPRESS_TEST_ENVIRONMENT: ${{ matrix.environment }}

      - name: Upload Failed Tests Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-failed-screenshots-${{ matrix.environment }}-${{ matrix.browser }}
          path: pets-ui/cypress/screenshots
          retention-days: 7

      - name: Merge Mochawesome Reports
        if: always()
        run: |
          JSON_DIR=pets-ui/cypress/reports/mochawesome/.jsons
          if ls ${JSON_DIR}/*.json 1> /dev/null 2>&1; then
            npx mochawesome-merge ${JSON_DIR}/*.json > pets-ui/cypress/reports/mochawesome/mochawesome.json
          else
            echo "No mochawesome JSON files found. Skipping merge."
          fi

      - name: Upload Mochawesome Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-mochawesome-report-${{ matrix.environment }}-${{ matrix.browser }}
          path: pets-ui/cypress/reports/mochawesome/
          retention-days: 7

      - name: Store env+browser result
        if: always()
        run: |
          if [[ "${{ steps.initial_attempt.outcome }}" == "success" ]] || [[ "${{ steps.retry_attempt.outcome }}" == "success" ]]; then
            echo "PASS" > ${{ matrix.environment }}-${{ matrix.browser }}-result.txt
          else
            echo "FAIL" > ${{ matrix.environment }}-${{ matrix.browser }}-result.txt
          fi

      - name: Upload env+browser result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: env-browser-result-${{ matrix.environment }}-${{ matrix.browser }}
          path: ${{ matrix.environment }}-${{ matrix.browser }}-result.txt

  generate-summary-and-deploy:
    name: Generate Summary and Deploy Dashboard
    needs: [setup-matrix, cypress-nightly]
    if: always()
    runs-on: ubuntu-latest
    continue-on-error: true   # allow report even if tests fail

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
          pattern: "*"

      - name: Generate test summary report
        id: summary
        run: |
          echo "# ğŸŒ™ Nightly Cypress Test Results" > nightly-summary.md
          echo "**Run Date**: $(date)" >> nightly-summary.md
          echo "**Run ID**: ${{ github.run_id }}" >> nightly-summary.md
          echo "" >> nightly-summary.md

          ENV_LIST=("qat" "dev" "preprod")
          BROWSER_LIST=("chrome" "firefox" "edge")

          TOTAL=0
          FAILS=0

          for env in "${ENV_LIST[@]}"; do
            echo "## Environment: $env" >> nightly-summary.md
            echo "" >> nightly-summary.md
            echo "| Browser | Status |" >> nightly-summary.md
            echo "|---------|--------|" >> nightly-summary.md

            for browser in "${BROWSER_LIST[@]}"; do
              RESULT_FILE="all-artifacts/env-browser-result-${env}-${browser}/${env}-${browser}-result.txt"
              STATUS="UNKNOWN"
              if [ -f "$RESULT_FILE" ]; then
                STATUS=$(cat "$RESULT_FILE")
              fi
              echo "| $browser | $([ "$STATUS" = "PASS" ] && echo "âœ… PASS" || echo "âŒ FAIL") |" >> nightly-summary.md
              TOTAL=$((TOTAL+1))
              if [ "$STATUS" != "PASS" ]; then
                FAILS=$((FAILS+1))
              fi
            done
            echo "" >> nightly-summary.md
          done

          if [ $FAILS -eq 0 ]; then
            echo "## âœ… Overall Status: PASSED" >> nightly-summary.md
            echo "All $TOTAL combinations passed." >> nightly-summary.md
            echo "overall_status=PASS" >> $GITHUB_OUTPUT
          else
            echo "## âŒ Overall Status: FAILED" >> nightly-summary.md
            echo "$FAILS of $TOTAL environmentâ€“browser combinations failed." >> nightly-summary.md
            echo "overall_status=FAIL" >> $GITHUB_OUTPUT
          fi

      - name: Create dashboard directory
        run: |
          mkdir -p dashboard
          cp .github/pages/index.html dashboard/ || echo "index.html not found, will create default"

      - name: Generate dashboard data JSON
        run: |
          cat > dashboard/test-results.json << EOF
          {
            "overallStatus": "${{ steps.summary.outputs.overall_status }}",
            "runUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          }
          EOF

      - name: Create default index.html if not exists
        run: |
          if [ ! -f "dashboard/index.html" ]; then
            cat > dashboard/index.html << 'EOF'
          <!DOCTYPE html>
          <html><head><title>Nightly Test Dashboard</title></head>
          <body><h1>Dashboard Loading...</h1>
          <script>
          setTimeout(() => {
            fetch('./test-results.json').then(r => r.json()).then(data => {
              document.body.innerHTML =
                '<div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto;">' +
                '<h1>ğŸŒ™ Nightly Tests: ' + data.overallStatus + '</h1>' +
                '<p><strong>Last Updated:</strong> ' + new Date(data.timestamp).toLocaleString() + '</p>' +
                '<p><a href=\"' + data.runUrl + '\" target=\"_blank\">ğŸ“Š View Detailed Results</a></p>' +
                '</div>';
            });
          }, 100);
          </script></body></html>
          EOF
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./dashboard"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Upload summary report
        uses: actions/upload-artifact@v4
        with:
          name: nightly-summary-report
          path: nightly-summary.md
          retention-days: 7

      - name: Set workflow conclusion
        if: always()
        run: |
          echo "ğŸ”— Dashboard URL: ${{ steps.deployment.outputs.page_url }}"
          if [[ "${{ steps.summary.outputs.overall_status }}" == "PASS" ]]; then
            echo "::notice::âœ… All nightly tests passed! Dashboard updated at ${{ steps.deployment.outputs.page_url }}"
          else
            echo "::warning::âš ï¸ Some tests failed. Dashboard still updated at ${{ steps.deployment.outputs.page_url }}"
          fi
