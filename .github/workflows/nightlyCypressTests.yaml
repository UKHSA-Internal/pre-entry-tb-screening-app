name: Nightly Cypress Tests

on:
  schedule:
    # Runs at 1 AM UTC every weekday (Monday to Friday)
    - cron: "0 1 * * 1-5"
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (dev, preprod, qat, all)"
        required: true
        default: "all"

# Add permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # Simple job to determine which environments to test
  determine-environments:
    name: Determine Target Environments
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.set-environments.outputs.environments }}
    steps:
      - name: Set environments
        id: set-environments
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]] || [[ "${{ github.event.inputs.environment }}" == "all" ]] || [[ "${{ github.event.inputs.environment }}" == "" ]]; then
            echo 'environments=["qat", "dev", "preprod"]' >> $GITHUB_OUTPUT
          else
            echo 'environments=["${{ github.event.inputs.environment }}"]' >> $GITHUB_OUTPUT
          fi

  cypress-nightly:
    name: Run Nightly Cypress Tests - ${{ matrix.browser }} on ${{ matrix.environment }}
    runs-on: ubuntu-latest
    needs: determine-environments
    strategy:
      fail-fast: false
      matrix:
        browser: [chrome, firefox, edge]
        environment: ${{ fromJson(needs.determine-environments.outputs.environments) }}

    env:
      # Set the environment for the Cypress config to pick up
      ENVIRONMENT: ${{ matrix.environment }}
      TARGET_ENV: ${{ matrix.environment }}
      USER_1_EMAIL: ${{ secrets.USER_1_EMAIL }}
      USER_1_PASSWORD: ${{ secrets.USER_1_PASSWORD }}
      USER_2_EMAIL: ${{ secrets.USER_2_EMAIL }}
      USER_2_PASSWORD: ${{ secrets.USER_2_PASSWORD }}
      USER_3_EMAIL: ${{ secrets.USER_3_EMAIL }}
      USER_3_PASSWORD: ${{ secrets.USER_3_PASSWORD }}
      USER_4_EMAIL: ${{ secrets.USER_4_EMAIL }}
      USER_4_PASSWORD: ${{ secrets.USER_4_PASSWORD }}
      USER_5_EMAIL: ${{ secrets.USER_5_EMAIL }}
      USER_5_PASSWORD: ${{ secrets.USER_5_PASSWORD }}
      USER_6_EMAIL: ${{ secrets.USER_6_EMAIL }}
      USER_6_PASSWORD: ${{ secrets.USER_6_PASSWORD }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm i

      - name: Debug available Cypress specs
        run: ls -R pets-ui/cypress/e2e

      - name: Cache Cypress binary
        id: cache-cypress-binary
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: cypress-binary-nightly-${{ runner.os }}-${{ hashFiles('pets-ui/package.json') }}

      - name: Install Cypress Binary
        if: steps.cache-cypress-binary.outputs.cache-hit != 'true'
        run: |
          pnpm exec cypress install --force
          pnpm exec cypress verify
        working-directory: pets-ui

      # Only start local environment if testing locally (not for remote environments)
      - name: Start Local Environment
        if: ${{ matrix.environment == 'local' }}
        run: |
          pnpm start & sleep 120

      - name: Cypress run tests
        uses: cypress-io/github-action@v6
        continue-on-error: true
        id: initial_attempt
        with:
          install: false
          working-directory: pets-ui
          browser: ${{ matrix.browser }}
          config-file: cypress/cypress.config.mjs

      - name: Retry if failed
        if: steps.initial_attempt.outcome != 'success'
        uses: cypress-io/github-action@v6
        id: retry_attempt
        with:
          install: false
          working-directory: pets-ui
          browser: ${{ matrix.browser }}
          config-file: cypress/cypress.config.mjs

      - name: Upload Failed Tests Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-failed-screenshots-${{ matrix.browser }}-${{ matrix.environment }}
          path: pets-ui/cypress/screenshots
          retention-days: 7

      - name: Merge Mochawesome Reports
        if: always()
        run: |
          JSON_DIR=pets-ui/cypress/reports/mochawesome/.jsons
          if ls ${JSON_DIR}/*.json 1> /dev/null 2>&1; then
            npx mochawesome-merge ${JSON_DIR}/*.json > pets-ui/cypress/reports/mochawesome/mochawesome.json
          else
            echo "No mochawesome JSON files found. Skipping merge."
          fi

      - name: Upload Mochawesome Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-mochawesome-report-${{ matrix.browser }}-${{ matrix.environment }}
          path: pets-ui/cypress/reports/mochawesome/
          retention-days: 7

      # Store browser-environment result for dashboard
      - name: Store browser-environment result
        if: always()
        run: |
          if [[ "${{ steps.initial_attempt.outcome }}" == "success" ]] || [[ "${{ steps.retry_attempt.outcome }}" == "success" ]]; then
            echo "PASS" > ${{ matrix.browser }}-${{ matrix.environment }}-result.txt
          else
            echo "FAIL" > ${{ matrix.browser }}-${{ matrix.environment }}-result.txt
          fi

      - name: Upload browser-environment result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: browser-result-${{ matrix.browser }}-${{ matrix.environment }}
          path: ${{ matrix.browser }}-${{ matrix.environment }}-result.txt

  generate-summary-and-deploy:
    name: Generate Summary and Deploy Dashboard
    needs: cypress-nightly
    if: always()
    runs-on: ubuntu-latest

    # Configure GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
          pattern: "*"

      - name: Generate test summary report
        id: summary
        run: |
          echo "# üåô Nightly Cypress Test Results" > nightly-summary.md
          echo "**Run Date**: $(date)" >> nightly-summary.md
          echo "**Run ID**: ${{ github.run_id }}" >> nightly-summary.md
          echo "**Trigger**: ${{ github.event_name }}" >> nightly-summary.md
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "**Target Environment**: ${{ github.event.inputs.environment }}" >> nightly-summary.md
          fi
          echo "" >> nightly-summary.md

          # Initialize counters
          TOTAL_COMBINATIONS=0
          FAILED_COMBINATIONS=0
          FAILED_TESTS=0

          echo "## Browser x Environment Test Results" >> nightly-summary.md
          echo "" >> nightly-summary.md
          echo "| Browser | QAT | DEV | PREPROD |" >> nightly-summary.md
          echo "|---------|-----|-----|---------|" >> nightly-summary.md

          # Check results for each browser-environment combination
          ENVIRONMENTS="qat dev preprod"
          BROWSERS="chrome firefox edge"

          # Initialize status variables
          chrome_qat_status="NOT_RUN"
          chrome_dev_status="NOT_RUN"
          chrome_preprod_status="NOT_RUN"
          firefox_qat_status="NOT_RUN"
          firefox_dev_status="NOT_RUN"
          firefox_preprod_status="NOT_RUN"
          edge_qat_status="NOT_RUN"
          edge_dev_status="NOT_RUN"
          edge_preprod_status="NOT_RUN"

          # Check each combination result
          for browser in $BROWSERS; do
            ROW="| $browser |"
            for env in $ENVIRONMENTS; do
              RESULT_FILE="all-artifacts/browser-result-$browser-$env/${browser}-${env}-result.txt"
              SCREENSHOT_DIR="all-artifacts/nightly-failed-screenshots-$browser-$env"
              
              if [ -f "$RESULT_FILE" ]; then
                RESULT=$(cat "$RESULT_FILE")
                TOTAL_COMBINATIONS=$((TOTAL_COMBINATIONS + 1))
              else
                RESULT="NOT_RUN"
              fi
              
              # Store status using eval to create dynamic variable names
              eval "${browser}_${env}_status=\"$RESULT\""
              
              if [ "$RESULT" = "FAIL" ]; then
                FAILED_COMBINATIONS=$((FAILED_COMBINATIONS + 1))
                if [ -d "$SCREENSHOT_DIR" ] && [ "$(ls -A "$SCREENSHOT_DIR" 2>/dev/null)" ]; then
                  SCREENSHOT_COUNT=$(find "$SCREENSHOT_DIR" -name "*.png" -o -name "*.jpg" | wc -l)
                  ROW="$ROW ‚ùå ($SCREENSHOT_COUNT) |"
                  FAILED_TESTS=$((FAILED_TESTS + SCREENSHOT_COUNT))
                else
                  ROW="$ROW ‚ùå |"
                fi
              elif [ "$RESULT" = "PASS" ]; then
                ROW="$ROW ‚úÖ |"
              else
                ROW="$ROW ‚ûñ |"
              fi
            done
            echo "$ROW" >> nightly-summary.md
          done

          echo "" >> nightly-summary.md

          # Overall status
          if [ $TOTAL_COMBINATIONS -eq 0 ]; then
            echo "## ‚ö†Ô∏è Overall Status: NO TESTS RUN" >> nightly-summary.md
            echo "No test combinations were executed." >> nightly-summary.md
            echo "status=NO_TESTS" >> $GITHUB_OUTPUT
            OVERALL_STATUS="NO_TESTS"
          elif [ $FAILED_COMBINATIONS -eq 0 ]; then
            echo "## ‚úÖ Overall Status: PASSED" >> nightly-summary.md
            echo "All browser-environment combinations passed!" >> nightly-summary.md
            echo "status=PASS" >> $GITHUB_OUTPUT
            OVERALL_STATUS="PASS"
          else
            echo "## ‚ùå Overall Status: FAILED" >> nightly-summary.md
            echo "$FAILED_COMBINATIONS out of $TOTAL_COMBINATIONS combination(s) have failing tests." >> nightly-summary.md
            echo "status=FAIL" >> $GITHUB_OUTPUT
            OVERALL_STATUS="FAIL"
          fi

          # Calculate success rate
          if [ $TOTAL_COMBINATIONS -gt 0 ]; then
            SUCCESS_RATE=$(( (TOTAL_COMBINATIONS - FAILED_COMBINATIONS) * 100 / TOTAL_COMBINATIONS ))
          else
            SUCCESS_RATE=0
          fi

          # Set outputs for dashboard
          echo "overall_status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
          echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "success_rate=${SUCCESS_RATE}%" >> $GITHUB_OUTPUT
          echo "failed_combinations=$FAILED_COMBINATIONS" >> $GITHUB_OUTPUT
          echo "total_combinations=$TOTAL_COMBINATIONS" >> $GITHUB_OUTPUT

          # Set individual statuses using eval to read dynamic variable names
          for browser in $BROWSERS; do
            for env in $ENVIRONMENTS; do
              eval "status=\$${browser}_${env}_status"
              echo "${browser}_${env}_status=$status" >> $GITHUB_OUTPUT
            done
          done

      - name: Create dashboard directory
        run: |
          mkdir -p dashboard
          cp .github/pages/index.html dashboard/ || echo "index.html not found, will create default"

      - name: Generate dashboard data JSON
        run: |
          cat > dashboard/test-results.json << EOF
          {
            "overallStatus": "${{ steps.summary.outputs.overall_status }}",
            "successRate": "${{ steps.summary.outputs.success_rate }}",
            "failedTests": ${{ steps.summary.outputs.failed_tests }},
            "failedCombinations": ${{ steps.summary.outputs.failed_combinations }},
            "totalCombinations": ${{ steps.summary.outputs.total_combinations }},
            "lastRunHours": 0,
            "triggerType": "${{ github.event_name }}",
            "targetEnvironment": "${{ github.event.inputs.environment || 'all' }}",
            "combinations": {
              "chrome": {
                "qat": "${{ steps.summary.outputs.chrome_qat_status }}",
                "dev": "${{ steps.summary.outputs.chrome_dev_status }}",
                "preprod": "${{ steps.summary.outputs.chrome_preprod_status }}"
              },
              "firefox": {
                "qat": "${{ steps.summary.outputs.firefox_qat_status }}",
                "dev": "${{ steps.summary.outputs.firefox_dev_status }}",
                "preprod": "${{ steps.summary.outputs.firefox_preprod_status }}"
              },
              "edge": {
                "qat": "${{ steps.summary.outputs.edge_qat_status }}",
                "dev": "${{ steps.summary.outputs.edge_dev_status }}",
                "preprod": "${{ steps.summary.outputs.edge_preprod_status }}"
              }
            },
            "runUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          }
          EOF

      - name: Create default index.html if not exists
        run: |
          if [ ! -f "dashboard/index.html" ]; then
            cat > dashboard/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
            <head>
              <title>Pre-Entry TB Screening - Nightly Test Dashboard</title>
              <style>
                body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
                .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
                .stats { display: flex; justify-content: space-around; margin: 20px 0; }
                .stat { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; min-width: 120px; }
                .stat-value { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
                .pass { color: #28a745; }
                .fail { color: #dc3545; }
                .no-tests { color: #6c757d; }
                .matrix { margin: 20px 0; }
                .matrix table { width: 100%; border-collapse: collapse; }
                .matrix th, .matrix td { border: 1px solid #ddd; padding: 12px; text-align: center; }
                .matrix th { background: #f8f9fa; font-weight: bold; }
                .status-pass { background: #d4edda; color: #155724; }
                .status-fail { background: #f8d7da; color: #721c24; }
                .status-not_run { background: #e2e3e5; color: #6c757d; }
                .meta-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
              </style>
            </head>
            <body>
              <div class="header">
                <h1>üåô Pre-Entry TB Screening - Nightly Tests</h1>
                <p>Cross-Browser & Cross-Environment Testing Dashboard</p>
              </div>
              <div id="content">Loading...</div>
              <script>
                fetch('./test-results.json').then(r => r.json()).then(data => {
                  const statusClass = data.overallStatus === 'PASS' ? 'pass' : data.overallStatus === 'NO_TESTS' ? 'no-tests' : 'fail';
                  
                  const content = `
                    <div class="meta-info">
                      <strong>Trigger:</strong> ${data.triggerType === 'schedule' ? 'Scheduled Run' : 'Manual Run'} | 
                      <strong>Target:</strong> ${data.targetEnvironment} | 
                      <strong>Last Updated:</strong> ${new Date(data.timestamp).toLocaleString()}
                    </div>
                    
                    <div class="stats">
                      <div class="stat">
                        <div class="stat-value ${statusClass}">${data.overallStatus}</div>
                        <div>Overall Status</div>
                      </div>
                      <div class="stat">
                        <div class="stat-value">${data.successRate}</div>
                        <div>Success Rate</div>
                      </div>
                      <div class="stat">
                        <div class="stat-value">${data.failedCombinations}/${data.totalCombinations}</div>
                        <div>Failed Combinations</div>
                      </div>
                      <div class="stat">
                        <div class="stat-value">${data.failedTests}</div>
                        <div>Failed Tests</div>
                      </div>
                    </div>
                    
                    <div class="matrix">
                      <h3>Browser √ó Environment Results</h3>
                      <table>
                        <thead>
                          <tr>
                            <th>Browser</th>
                            <th>QAT</th>
                            <th>DEV</th>
                            <th>PREPROD</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td><strong>Chrome</strong></td>
                            <td class="status-${data.combinations.chrome.qat.toLowerCase()}">${data.combinations.chrome.qat}</td>
                            <td class="status-${data.combinations.chrome.dev.toLowerCase()}">${data.combinations.chrome.dev}</td>
                            <td class="status-${data.combinations.chrome.preprod.toLowerCase()}">${data.combinations.chrome.preprod}</td>
                          </tr>
                          <tr>
                            <td><strong>Firefox</strong></td>
                            <td class="status-${data.combinations.firefox.qat.toLowerCase()}">${data.combinations.firefox.qat}</td>
                            <td class="status-${data.combinations.firefox.dev.toLowerCase()}">${data.combinations.firefox.dev}</td>
                            <td class="status-${data.combinations.firefox.preprod.toLowerCase()}">${data.combinations.firefox.preprod}</td>
                          </tr>
                          <tr>
                            <td><strong>Edge</strong></td>
                            <td class="status-${data.combinations.edge.qat.toLowerCase()}">${data.combinations.edge.qat}</td>
                            <td class="status-${data.combinations.edge.dev.toLowerCase()}">${data.combinations.edge.dev}</td>
                            <td class="status-${data.combinations.edge.preprod.toLowerCase()}">${data.combinations.edge.preprod}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                      <a href="${data.runUrl}" target="_blank" style="background: #0066cc; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;">üìä View Detailed Results</a>
                    </div>
                  `;
                  document.getElementById('content').innerHTML = content;
                });
              </script>
            </body>
          </html>
          EOF
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./dashboard"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Upload summary report
        uses: actions/upload-artifact@v4
        with:
          name: nightly-summary-report
          path: nightly-summary.md
          retention-days: 7

      # Set final workflow status
      - name: Set workflow conclusion
        if: always()
        run: |
          echo "üîó Dashboard URL: ${{ steps.deployment.outputs.page_url }}"
          if [[ "${{ steps.summary.outputs.status }}" == "PASS" ]]; then
            echo "::notice::‚úÖ All nightly tests passed! Dashboard updated at ${{ steps.deployment.outputs.page_url }}"
          elif [[ "${{ steps.summary.outputs.status }}" == "NO_TESTS" ]]; then
            echo "::warning::‚ö†Ô∏è No tests were executed. Check configuration. Dashboard: ${{ steps.deployment.outputs.page_url }}"
          else
            echo "::error::‚ùå Some nightly tests failed. Check dashboard: ${{ steps.deployment.outputs.page_url }}"
            exit 1
          fi
