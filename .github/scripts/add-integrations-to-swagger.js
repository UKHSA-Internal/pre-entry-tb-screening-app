module.exports = (serviceName) => {
    // Convert autogenerated swagger.js file to JSON
    let inputFilePath = `core-services/${serviceName}/swagger/swagger.js`
    const fs = require('fs')
    let swaggerAsArray = fs.readFileSync(inputFilePath, 'utf-8').split('\n')
    swaggerAsArray = swaggerAsArray.slice(2,-1)
    let swaggerAsString = '{' + swaggerAsArray.join('') + '}'
    let swaggerAsJson = JSON.parse(swaggerAsString)

    // Define security blocks
    let securityBlock = [{
        'authorizer' : []
    }]
    let securityDefinitions = {
        'authorizer' : {
            'type' : 'apiKey',
            'name': 'Authorization',
            'in' : 'header',
            'x-amazon-apigateway-authtype' : 'custom',
            'x-amazon-apigateway-authorizer' : {
                'type' : 'token',
                'authorizerUri' : 'arn:aws:apigateway:eu-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-west-2:AWS_ACCOUNT_ID:function:api-gateway-authoriser/invocations',
                'authorizerCredentials' : 'arn:aws:iam::AWS_ACCOUNT_ID:role/api_gateway_auth_invocation',
                'identityValidationExpression' : '^x-[a-z]+',
                'authorizerResultTtlInSeconds' : 300
            }
        }
    }

    // Define integration block
    let integrationBlock = {
        'uri': '',
        'passthroughBehavior': 'when_no_match',
        'httpMethod': '',
        'type': 'aws_proxy'
    }

    // Create array of URI names that will be used later in deployment pipeline to insert URIs
    let uriSecretNames = []

    // Insert integration & security blocks for each HTTP Method in each path
    for (let path in swaggerAsJson['paths']) {
        for (let httpMethod in swaggerAsJson['paths'][path]) {
            swaggerAsJson['paths'][path][httpMethod]['security'] = securityBlock
            swaggerAsJson['paths'][path][httpMethod]['x-amazon-apigateway-integration'] = {...integrationBlock} // Spreading the object clones it, preventing original object from being referenced when fields are amended
            let uriSecretName = 'CORESERVICESURIS_' + path.toUpperCase() + '_' + httpMethod.toUpperCase()
            uriSecretName = uriSecretName.replace(/[^A-Z0-9_]/g, ''); // Removing special characters to conform to GHA Secret naming rules
            uriSecretNames.push(uriSecretName)
            swaggerAsJson['paths'][path][httpMethod]['x-amazon-apigateway-integration']['uri'] = uriSecretName
            swaggerAsJson['paths'][path][httpMethod]['x-amazon-apigateway-integration']['httpMethod'] = httpMethod.toUpperCase()
        }
    }

    // Insert security definitions block
    swaggerAsJson['securityDefinitions'] = securityDefinitions

    // Insert secret values into swagger spec & write to swagger.json
    let swaggerSpec = JSON.stringify(swaggerAsJson)
    swaggerSpec = swaggerSpec.replaceAll('AWS_ACCOUNT_ID', process.env.AWS_ACCOUNT_ID)
    for (uri of uriSecretNames) {
        swaggerSpec = swaggerSpec.replace(uri, eval('process.env.' + uri))
    }
    fs.writeFile(`core-services/${serviceName}/swagger.json`, swaggerSpec, (err) => {if (err) throw err;});
}
