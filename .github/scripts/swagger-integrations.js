// Convert autogenerated swagger.js file to JSON
let inputFilePath = 'core-services/clinic-service/swagger/swagger.js'
const fs = require('fs')
let swaggerAsArray = fs.readFileSync(inputFilePath, 'utf-8').split('\n')
swaggerAsArray = swaggerAsArray.slice(2,-1)
let swaggerAsString = '{' + swaggerAsArray.join('') + '}'
let swaggerAsJson = JSON.parse(swaggerAsString)

// Define integration block
let integrationBlock = {
    'uri': '',
    'passthroughBehavior': 'when_no_match',
    'httpMethod': '',
    'type': 'aws_proxy'
}

// Create array of URI names that will be used later in deployment pipeline to insert URIs
let uriSecretNames = []

// Insert integration block for each HTTP Method in each path
for (let path in swaggerAsJson['paths']) {
    for (let httpMethod in swaggerAsJson['paths'][path]) {
        swaggerAsJson['paths'][path][httpMethod]['x-amazon-apigateway-integration'] = {...integrationBlock} // Spreading the object clones it, preventing original object from being referenced when fields are amended
        let uriSecretName = 'CLINIC_SERVICE_URIS_' + path.toUpperCase() + '_' + httpMethod.toUpperCase()
        uriSecretName = uriSecretName.replace(/[^A-Z0-9_]/g, ''); // Removing special characters to conform to GHA Secret naming rules
        uriSecretNames.push(uriSecretName)
        swaggerAsJson['paths'][path][httpMethod]['x-amazon-apigateway-integration']['uri'] = uriSecretName
        swaggerAsJson['paths'][path][httpMethod]['x-amazon-apigateway-integration']['httpMethod'] = httpMethod.toUpperCase()
    }
}

// Insert secret values into swagger spec & write to swagger.json
let swaggerSpec = JSON.stringify(swaggerAsJson)
for (uri of uriSecretNames) {
    swaggerSpec = swaggerSpec.replace(uri, eval('process.env.' + uri))
}
fs.writeFile('swagger.json', swaggerSpec, (err) => {if (err) throw err;});


module.exports = () => {
    return {
        'uriSecretNames': uriSecretNames,
        'swaggerSpec': swaggerSpec
    }
}