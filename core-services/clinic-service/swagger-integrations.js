// Convert autogenerated swagger.js file to JSON
let inputFilePath = 'core-services/clinic-service/swagger/swagger.js'
fs = require('fs')
var swaggerAsArray = fs.readFileSync(inputFilePath, 'utf-8').split('\n')
swaggerAsArray = swaggerAsArray.slice(2,-1)
var swaggerAsString = '{' + swaggerAsArray.join('') + '}'
var swaggerAsJson = JSON.parse(swaggerAsString)

// Define integration block
let integrationBlock = {
    'uri': '',
    'passthroughBehavior': 'when_no_match',
    'httpMethod': '',
    'type': 'aws_proxy'
}

// Create array of URI names that will be used later in deployment pipeline to insert URIs
let uriSecretNames = []

// Insert integration block for each HTTP Method in each path
for (path in swaggerAsJson['paths']) {
    for (httpMethod in swaggerAsJson['paths'][path]) {
        swaggerAsJson['paths'][path][httpMethod]['x-amazon-apigateway-integration'] = {...integrationBlock} // Spreading the object clones it, preventing original object from being referenced when fields are amended
        let uriSecretName = 'CLINIC_SERVICE_URIS_' + path.toUpperCase() + '_' + httpMethod.toUpperCase()
        uriSecretName = uriSecretName.replace(/[^A-Z0-9_]/g, ''); // Removing special characters to conform to GHA Secret naming rules
        uriSecretNames.push(uriSecretName)
        swaggerAsJson['paths'][path][httpMethod]['x-amazon-apigateway-integration']['uri'] = uriSecretName
        swaggerAsJson['paths'][path][httpMethod]['x-amazon-apigateway-integration']['httpMethod'] = httpMethod.toUpperCase()
    }
}

module.exports = () => {
    return {
        'uriSecretNames': uriSecretNames,
        'swaggerSpec': JSON.stringify(swaggerAsJson)
    }
}